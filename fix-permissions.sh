#!/bin/bash

# ============================================
# ุณูุฑุจุช ูุชุนุฏูู ุฃุฐููุงุช ุงููููุงุช ูุงููุฌูุฏุงุช
# ุงููุฌูุฏุงุช: 755
# ุงููููุงุช: 644
# ============================================

# ุนุฑุถ ูุนูููุงุช ุญูู ุงูุณูุฑุจุช
echo "============================================"
echo "  ุณูุฑุจุช ุชุนุฏูู ุฃุฐููุงุช ุงููููุงุช ูุงููุฌูุฏุงุช"
echo "============================================"
echo "ุงููุฌูุฏุงุช ุณุชุตุจุญ: 755 (rwxr-xr-x)"
echo "ุงููููุงุช ุณุชุตุจุญ: 644 (rw-r--r--)"
echo "============================================"
echo ""

# ุงูุชุญูู ูู ูุฌูุฏ ูุณูุท (ูุณุงุฑ ุงููุฌูุฏ)
if [ -z "$1" ]; then
    echo "โ ุฎุทุฃ: ูุฌุจ ุชุญุฏูุฏ ูุณุงุฑ ุงููุฌูุฏ"
    echo ""
    echo "ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู:"
    echo "  $0 <ูุณุงุฑ_ุงููุฌูุฏ>"
    echo ""
    echo "ุฃูุซูุฉ:"
    echo "  $0 /home/user/documents"
    echo "  $0 ./myfolder"
    echo "  $0 .   (ูููุฌูุฏ ุงูุญุงูู)"
    exit 1
fi

TARGET_DIR="$1"

# ุงูุชุญูู ูู ูุฌูุฏ ุงููุฌูุฏ
if [ ! -d "$TARGET_DIR" ]; then
    echo "โ ุฎุทุฃ: ุงููุฌูุฏ '$TARGET_DIR' ุบูุฑ ููุฌูุฏ!"
    exit 1
fi

# ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
if [ ! -w "$TARGET_DIR" ]; then
    echo "โ๏ธ  ุชุญุฐูุฑ: ููุณ ูุฏูู ุตูุงุญูุฉ ุงููุชุงุจุฉ ุนูู ูุฐุง ุงููุฌูุฏ"
    echo "ูุฏ ุชุญุชุงุฌ ุฅูู ุชุดุบูู ุงูุณูุฑุจุช ุจุงุณุชุฎุฏุงู sudo"
    read -p "ูู ุชุฑูุฏ ุงููุชุงุจุนุฉ ูุน sudoุ (y/n): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        SUDO_CMD="sudo"
    else
        echo "ุชู ุงูุฅูุบุงุก"
        exit 1
    fi
else
    SUDO_CMD=""
fi

# ุนุฑุถ ูุนูููุงุช ุนู ุงููุฌูุฏ
echo "ุงููุฌูุฏ ุงููุณุชูุฏู: $(realpath "$TARGET_DIR")"
echo "ุงููุงูู: $(stat -c '%U:%G' "$TARGET_DIR")"
echo ""

# ุนุฏ ุงููููุงุช ูุงููุฌูุฏุงุช
DIR_COUNT=$(${SUDO_CMD} find "$TARGET_DIR" -type d | wc -l)
FILE_COUNT=$(${SUDO_CMD} find "$TARGET_DIR" -type f | wc -l)

echo "ุฅุญุตุงุฆูุงุช ุงููุฌูุฏ:"
echo "  ุนุฏุฏ ุงููุฌูุฏุงุช: $DIR_COUNT"
echo "  ุนุฏุฏ ุงููููุงุช: $FILE_COUNT"
echo ""

# ุนุฑุถ ุนููุฉ ูู ุงูุฃุฐููุงุช ุงูุญุงููุฉ
echo "ุนููุฉ ูู ุงูุฃุฐููุงุช ุงูุญุงููุฉ:"
echo "--------------------------"
${SUDO_CMD} find "$TARGET_DIR" -maxdepth 1 -type d | head -5 | while read dir; do
    if [ -n "$dir" ]; then
        perm=$(${SUDO_CMD} stat -c '%A %n' "$dir" 2>/dev/null)
        echo "๐ $perm"
    fi
done

${SUDO_CMD} find "$TARGET_DIR" -maxdepth 1 -type f | head -5 | while read file; do
    if [ -n "$file" ]; then
        perm=$(${SUDO_CMD} stat -c '%A %n' "$file" 2>/dev/null)
        echo "๐ $perm"
    fi
done
echo ""

# ุทูุจ ุชุฃููุฏ ูู ุงููุณุชุฎุฏู
echo "============================================"
read -p "ูู ุชุฑูุฏ ุชุนุฏูู ุฃุฐููุงุช $FILE_COUNT ููู ู $DIR_COUNT ูุฌูุฏุ (y/n): " -n 1 -r
echo ""
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "ุชู ุงูุฅูุบุงุก"
    exit 0
fi

# ============================================
# ุจุฏุก ุนูููุฉ ุงูุชุนุฏูู
# ============================================
echo "ุฌุงุฑู ุชุนุฏูู ุงูุฃุฐููุงุช..."
echo "------------------------"

# ุชุนุฏูู ุฃุฐููุงุช ุงููุฌูุฏุงุช
echo "1. ุฌุงุฑู ุชุนุฏูู ุฃุฐููุงุช ุงููุฌูุฏุงุช ุฅูู 755..."
if ${SUDO_CMD} find "$TARGET_DIR" -type d -exec chmod 755 {} \; 2>/dev/null; then
    echo "   โ ุชู ุชุนุฏูู ุฃุฐููุงุช $DIR_COUNT ูุฌูุฏ"
else
    echo "   โ ุญุฏุซ ุฎุทุฃ ูู ุชุนุฏูู ุฃุฐููุงุช ุงููุฌูุฏุงุช"
    ERROR=1
fi

# ุชุนุฏูู ุฃุฐููุงุช ุงููููุงุช
echo "2. ุฌุงุฑู ุชุนุฏูู ุฃุฐููุงุช ุงููููุงุช ุฅูู 644..."
if ${SUDO_CMD} find "$TARGET_DIR" -type f -exec chmod 644 {} \; 2>/dev/null; then
    echo "   โ ุชู ุชุนุฏูู ุฃุฐููุงุช $FILE_COUNT ููู"
else
    echo "   โ ุญุฏุซ ุฎุทุฃ ูู ุชุนุฏูู ุฃุฐููุงุช ุงููููุงุช"
    ERROR=1
fi

echo ""
echo "============================================"

# ุงูุชุญูู ูู ุงููุชูุฌุฉ
if [ -z "$ERROR" ]; then
    echo "๐ ุชู ุชุนุฏูู ุงูุฃุฐููุงุช ุจูุฌุงุญ!"
    echo ""
    
    # ุนุฑุถ ุนููุฉ ูู ุงูุฃุฐููุงุช ุงูุฌุฏูุฏุฉ
    echo "ุนููุฉ ูู ุงูุฃุฐููุงุช ุงูุฌุฏูุฏุฉ:"
    echo "--------------------------"
    ${SUDO_CMD} find "$TARGET_DIR" -maxdepth 1 -type d | head -3 | while read dir; do
        if [ -n "$dir" ]; then
            perm=$(${SUDO_CMD} stat -c '%A %n' "$dir" 2>/dev/null)
            echo "๐ $perm"
        fi
    done
    
    ${SUDO_CMD} find "$TARGET_DIR" -maxdepth 1 -type f | head -3 | while read file; do
        if [ -n "$file" ]; then
            perm=$(${SUDO_CMD} stat -c '%A %n' "$file" 2>/dev/null)
            echo "๐ $perm"
        fi
    done
else
    echo "โ๏ธ  ุญุฏุซุช ุจุนุถ ุงูุฃุฎุทุงุก ุฎูุงู ุนูููุฉ ุงูุชุนุฏูู"
    echo "ูุฏ ุชุญุชุงุฌ ุฅูู ุชุดุบูู ุงูุณูุฑุจุช ุจุงุณุชุฎุฏุงู sudo"
fi

echo ""
echo "============================================"
echo "ุชู ุงูุงูุชูุงุก ูู: $(date)"
echo "============================================"